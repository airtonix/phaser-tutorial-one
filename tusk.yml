options:
  project_name:
    environment: PROJECT_NAME
    default:
      command: basename $PWD

  docker_registry:
    environment: DOCKER_REPO
    default: docker.pkg.github.com/airtonix/phaser-tutorial-ones

tasks:

  dev:
    run:
      - task: dev:setup
      - task:
          name: docker:up
          options:
            services: app
            stage: local

  dev:setup:
    run:
      - task:
          name: docker:build
          options:
            source: app

  dev:test:
    run:
      - task:
          name: docker:tusk
          options:
            stage: local
            service: app
            command: test:watch

  dev:shell:
    run:
      - task:
          name: docker:run
          options:
            stage: local
            service: app
            command: /bin/sh

  #
  # CI
  #
  ci:setup:
    run:
      - task:
          name: docker:build
          options:
            appname: app
            repo: airtonix/${project_name}

  ci:test:
    run:
      - task:
          name: docker:tusk
          options:
            service: app
            stage: ci
            command: test

  #
  # Docker
  #
  docker:build:
    options:
      source:
        usage: Directory to use
      repo:
        usage: Docker repository to use
        type: string
        default: ${docker_registry}/${project_name}
    run:
    - command: docker pull ${repo}:builder || true
    - command: >-
        docker build
        --cache-from ${repo}:builder
        --file ./${source}/Dockerfile
        --tag ${repo}:builder
        --target install
        ./${source}
    - command: docker pull ${repo}:latest || true
    - command: >-
        docker build
        --build-arg COMMIT=${version}
        --cache-from ${repo}:builder
        --cache-from ${repo}:latest
        --file ./${source}/Dockerfile
        --tag ${project_name}:latest
        --target prod
        ./${source}
    - when: publishbuilder
      command: docker push ${repo}:builder

  docker:run:
    options:
      service:
        usage: docker-compose service name
      stage:
        default: local
      command:
        usage: command to run
    run: >-
      docker-compose
      -f docker-compose.yml
      -f docker-compose--${stage}.yml
      run --rm
      ${service} ${command}

  docker:up:
    options:
      services:
        usage: docker-compose service name(s)
      stage:
        default: local
    run:
      - >-
        docker-compose
        -f docker-compose.yml
        -f docker-compose--${stage}.yml
        up ${services}

  docker:tusk:
    options:
      service:
        usage: docker-compose service name
      command:
        usage: command to run
      stage:
        default: local
    run:
      - task:
          name: docker:run
          options:
            service: ${service}
            command: ${command}
            stage: ${stage}

  docker:publish:
    options:
      repo:
        usage: Docker repository to use
        type: string
        default: ${docker_registry}/${project_name}
      tag:
        usage: New docker tag
    run:
      - docker tag ${repo} ${tag}
      - docker push ${repo}:builder